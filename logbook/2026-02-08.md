# 2026-02-08

## What I did
- lab04에서 hardware prefetcher 효과를 관찰하기 위해 stride sweep 실험을 설계하고 실행함  
- stride가 커도 모든 원소를 정확히 1번씩 방문하도록 offset loop 구조로 커널을 수정함  
- __builtin_prefetch를 켠 경우와 끈 경우를 dist(lookahead 거리) 후보군으로 스윕하며 비교함  
- dist를 계산으로 예측하기 위해 test.cpp를 만들고, TSC 기반 cycle 측정(rdtsc/rdtscp + lfence)을 적용함  
- pointer-chase 기반으로 대략적인 메모리 latency(L_lat_cyc)를 측정하고, 커널의 1회 접근당 비용(T_iter_cyc)을 같이 측정해 dist_pred를 계산함  
- 측정 흔들림을 줄이기 위해 warmup과 간단 thrash(캐시 흔들림 완화용) 아이디어를 적용함  

## Key results
- dist의 최적점은 단조적으로 커지거나 작아지는 게 아니라, stride마다 다른 최적 dist가 나타날 수 있음을 확인함  
- dist_pred는 대략 L_lat_cyc / T_iter_cyc로 계산 가능했고, 실제 best_dist가 작은 값(예: 1~6)에서만 결정되지 않고 stride가 커질수록 15~34 같은 더 큰 예측값이 나오기도 했음  
- 일부 stride 구간에서는 prefetch로 개선이 거의 없거나(best_dist=none), 오히려 악화되는 경우도 관측되어 prefetch는 항상 이득이 아니라는 점을 확인함  
- cycle 기반 측정으로 ns 기반 측정보다 실험 해석이 더 또렷해졌고, dist 최적점이 메모리 페널티와 루프 1회 비용의 균형으로 결정된다는 관점을 강화함  

## Takeaways
- prefetch 실험은 단순한 단조성 가설로 설명하기 어렵고, stride별로 최적 dist를 찾아야 하는 문제에 가까움  
- dist 최적점의 핵심 직관은 기다릴 latency(L) 동안 루프가 얼마나 일을 해주느냐(T)이며, dist는 그 간격을 맞추는 튜닝 파라미터로 해석하는 게 자연스러움  
- cycle 측정은 경계가 흐려지기 쉬워 fence와 올바른 rdtsc/rdtscp 조합이 중요하고, 캐시 상태/실행 환경 흔들림까지 같이 관리해야 실험이 의미 있게 됨  
